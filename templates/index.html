{% comment %} <!DOCTYPE html>
<html>
<head>
  <title>Smart Attendance</title>
</head>
<body>
  <h2>üì∏ Smart Attendance</h2>
  <video id="video" autoplay playsinline width="300" height="200"></video><br>
  <button onclick="captureAndSend()">Mark Attendance</button>

  <p id="result">Waiting...</p>

  <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // üîπ Start camera
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert("Camera access denied: " + err); });

  async function captureAndSend() {
    // Take photo
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let imageData = canvas.toDataURL("image/png");

    // Get location
    navigator.geolocation.getCurrentPosition(async (pos) => {
      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;

      let res = await fetch("/attendance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: imageData, lat: lat, lon: lon })
      });

      let result = await res.json();
      document.getElementById("result").innerText = result.message;
    }, () => {
      document.getElementById("result").innerText = "‚ùå Location access denied!";
    });
  }
</script>
</body>
</html> {% endcomment %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Smart Attendance</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #video { border: 2px solid black; margin-top: 10px; }
    button { padding: 10px 20px; margin-top: 15px; font-size: 16px; }
    #status { margin-top: 15px; font-weight: bold; font-size: 18px; }
  </style>
</head>
<body>
  <h1>üìç Face + Location Attendance</h1>

  <video id="video" width="320" height="240" autoplay muted></video>
  <br>
  <button onclick="startVerification()">Mark Attendance</button>
  <p id="status">Waiting...</p>

  <script>
    // -------------------
    // Config: Class Location
    // -------------------
    const CLASS_LAT = 16.7953091;
    const CLASS_LON = 80.8228997;
    const DEFAULT_RADIUS_METERS = 10;

    // -------------------
    // Known Face Encoding (example)
    // -------------------
    const knownEncoding = [
      -0.21994406, 0.08236794, 0.05143112, -0.0571159, 0.02412947, -0.03512193,
      0.02769779, -0.08322456, 0.18933475, -0.08251249, 0.28062588, -0.02774936,
      -0.22787049, -0.1260772, 0.05716535, 0.11886792, -0.13367793, -0.11807381,
      -0.05193415, -0.11017797, 0.07183637, -0.05433441, 0.05328489, 0.12170778,
      -0.19458061, -0.31278425, -0.12613252, -0.12564665, 0.00877065, -0.12787908,
      -0.01837935, -0.07100377, -0.2616086, -0.07378796, -0.05732656, 0.08189137,
      -0.01879851, -0.06106608, 0.17910828, -0.01620582, -0.11978003, -0.06089769,
      -0.01060433, 0.22059707, 0.13673146, 0.01119261, 0.00294999, -0.01760373,
      0.00326612, -0.23163997, 0.02685793, 0.09023806, 0.07827414, 0.03871822,
      0.04746759, -0.18176757, -0.00923449, 0.07679501, -0.15552892, 0.04048435,
      -0.01607412, -0.06525278, -0.00508338, -0.01092117, 0.26484329, 0.1393155,
      -0.16776516, -0.09370399, 0.10140089, -0.10721306, 0.05800693, 0.0949785,
      -0.09453231, -0.22189745, -0.31943911, 0.12229219, 0.44029588, 0.1043664,
      -0.1926896, -0.01631987, -0.17191915, 0.00238317, 0.05103629, 0.03078607,
      -0.11182864, 0.05516224, -0.12862118, 0.08031211, 0.14104569, 0.03511178,
      -0.07943838, 0.17432131, -0.0590466, 0.09033143, 0.04826321, 0.07395397,
      -0.10314577, -0.01575765, -0.06629934, 0.06494925, 0.01730468, -0.09228993,
      -0.00803042, 0.10109907, -0.14149156, 0.08871645, 0.03560997, -0.09258564,
      -0.10160367, 0.09902704, -0.19569722, -0.04178892, 0.09492321, -0.32151833,
      0.19337125, 0.22194211, -0.02031304, 0.18702291, 0.09087146, 0.06564561,
      -0.03497, 0.03406234, -0.09005363, -0.01184531, 0.05778141, -0.02403678,
      0.14184506, 0.00502164
    ];

    // -------------------
    // Utility: Euclidean Distance
    // -------------------
    function euclideanDistance(arr1, arr2) {
      return Math.sqrt(arr1.reduce((sum, val, i) => sum + Math.pow(val - arr2[i], 2), 0));
    }

    // -------------------
    // Haversine Formula
    // -------------------
    function haversine(lat1, lon1, lat2, lon2) {
      function toRad(x) { return x * Math.PI / 180; }
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) ** 2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // -------------------
    // Load models + Webcam
    // -------------------
    async function loadModels() {
      await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
      await faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
      await faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
    }

    async function startWebcam() {
      const video = document.getElementById("video");
      const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
      video.srcObject = stream;
    }

    // -------------------
    // Verification
    // -------------------
    async function startVerification() {
      document.getElementById("status").innerText = "Checking location...";

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const distance = haversine(CLASS_LAT, CLASS_LON, lat, lon);

        if (distance > DEFAULT_RADIUS_METERS) {
          document.getElementById("status").innerText = `‚ùå Not in class! (${distance.toFixed(2)}m away)`;
          return;
        }

        document.getElementById("status").innerText = "‚úÖ Location OK, checking face...";

        const detection = await faceapi
          .detectSingleFace(document.getElementById("video"), new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks()
          .withFaceDescriptor();

        if (!detection) {
          document.getElementById("status").innerText = "‚ùå No face detected!";
          return;
        }

        const distanceFace = euclideanDistance(knownEncoding, detection.descriptor);
        if (distanceFace < 0.4) {
          document.getElementById("status").innerText = "üéâ Attendance marked!";
          
          // Save attendance on server
          fetch("/mark_attendance", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: "Student1" })
          })
          .then(res => res.json())
          .then(data => console.log("Saved:", data));
        } else {
          document.getElementById("status").innerText = `‚ùå Face does not match! (dist=${distanceFace.toFixed(2)})`;
        }
      }, () => {
        document.getElementById("status").innerText = "‚ùå Location access denied!";
      });
    }

    loadModels();
    startWebcam();
  </script>
</body>
</html>
